#!/bin/bash

set -e

#yarn pack-all

dir1=$(mktemp -d)
dir2=$(mktemp -d)
dir3=$(mktemp -d)

etc/prepare-npm-package.mjs modules/build-raptor "$dir1" 
etc/prepare-npm-package.mjs modules/build-raptor-jest-reporter "$dir2"
etc/prepare-npm-package.mjs modules/build-raptor-api "$dir3"

pushd "$dir1"
CURRENT_VERSION=$(npm info build-raptor version)
npm pkg set "version=$CURRENT_VERSION"
npm version minor
NEXT_VERSION=$(npm pkg get version | tr -d '"')
echo "resolved new version: $NEXT_VERSION"
npm pkg set "dependencies.build-raptor-jest-reporter=$NEXT_VERSION"
popd



pushd "$dir2"
npm pkg set "version=$NEXT_VERSION"
echo "pubishing build-raptor-jest-reporter $NEXT_VERSION"
npm publish
popd

pushd "$dir3"
npm pkg set "version=$NEXT_VERSION"
echo "pubishing build-raptor-api $NEXT_VERSION"
npm publish
popd

pushd "$dir1"
echo "pubishing build-raptor $NEXT_VERSION"
npm publish
popd


T="published@$NEXT_VERSION"
echo tagging "$T"
git tag "$T"
git push --tags
